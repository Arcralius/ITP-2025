<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Data Dashboard</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: auto;
            background-color: #fff;
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        h1 {
            margin: 0;
            color: #2c3e50;
        }
        #refreshButton {
            padding: 10px 15px;
            font-size: 16px;
            color: #fff;
            background-color: #3498db;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #refreshButton:hover {
            background-color: #2980b9;
        }
        
        /* Consistent table container sizing */
        .table-container {
            width: 100%;
            min-height: 600px; /* Ensures consistent height */
            overflow-x: auto;
        }
        
        table.dataTable {
            width: 100% !important;
            margin: 20px 0;
            border-collapse: collapse;
            table-layout: fixed; /* Forces consistent column widths */
        }
        
        table.dataTable th, table.dataTable td {
            padding: 12px 15px;
            word-wrap: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        table.dataTable thead th {
            background-color: #34495e;
            color: #ffffff;
            font-weight: 600;
            white-space: nowrap;
        }
        
        table.dataTable tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        /* Specific column widths for consistency */
        #pdnsTable th:nth-child(1), #pdnsTable td:nth-child(1) { width: 8%; } /* ID */
        #pdnsTable th:nth-child(2), #pdnsTable td:nth-child(2) { width: 15%; } /* Timestamp */
        #pdnsTable th:nth-child(3), #pdnsTable td:nth-child(3) { width: 25%; } /* Domain */
        #pdnsTable th:nth-child(4), #pdnsTable td:nth-child(4) { width: 15%; } /* Resolved IP */
        #pdnsTable th:nth-child(5), #pdnsTable td:nth-child(5) { width: 10%; } /* Status */
        #pdnsTable th:nth-child(6), #pdnsTable td:nth-child(6) { width: 13.5%; } /* Received At */
        #pdnsTable th:nth-child(7), #pdnsTable td:nth-child(7) { width: 13.5%; } /* Processed At */
        
        #batchesTable th:nth-child(1), #batchesTable td:nth-child(1) { width: 10%; } /* ID */
        #batchesTable th:nth-child(2), #batchesTable td:nth-child(2) { width: 25%; } /* Batch ID */
        #batchesTable th:nth-child(3), #batchesTable td:nth-child(3) { width: 15%; } /* Record Count */
        #batchesTable th:nth-child(4), #batchesTable td:nth-child(4) { width: 25%; } /* Received At */
        #batchesTable th:nth-child(5), #batchesTable td:nth-child(5) { width: 25%; } /* Status */
        
        #heartbeatsTable th:nth-child(1), #heartbeatsTable td:nth-child(1) { width: 33.33%; } /* Sensor ID */
        #heartbeatsTable th:nth-child(2), #heartbeatsTable td:nth-child(2) { width: 33.33%; } /* Timestamp */
        #heartbeatsTable th:nth-child(3), #heartbeatsTable td:nth-child(3) { width: 33.34%; } /* Received At */
        
        .dataTables_wrapper .dataTables_filter input,
        .dataTables_wrapper .dataTables_length select {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px;
        }
        
        .dataTables_wrapper {
            width: 100%;
        }
        
        .payload-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Tab styles */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 5px 5px 0 0;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #ccc;
        }
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 5px 5px;
            min-height: 650px; /* Consistent tab content height */
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        .status-success {
            background-color: #27ae60;
            color: white;
        }
        .status-warning {
            background-color: #f39c12;
            color: white;
        }
        .status-secondary {
            background-color: #95a5a6;
            color: white;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-controls">
        <h1>Sensor Data Dashboard</h1>
        <button id="refreshButton" onclick="refreshActiveTable()">Refresh</button>
    </div>

    <div class="tab">
        <button class="tablinks" onclick="openTab(event, 'PDNS')" id="defaultOpen">PDNS Data</button>
        <button class="tablinks" onclick="openTab(event, 'Batches')">Upload Batches</button>
        <button class="tablinks" onclick="openTab(event, 'Heartbeats')">Heartbeats</button>
    </div>

    <div id="PDNS" class="tabcontent">
        <h2>PDNS Data</h2>
        <div class="table-container">
            <table id="pdnsTable" class="display">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Timestamp</th>
                        <th>Domain</th>
                        <th>Resolved IP</th>
                        <th>Status</th>
                        <th>Received At</th>
                        <th>Processed At</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="Batches" class="tabcontent">
        <h2>Upload Batches</h2>
        <div class="table-container">
            <table id="batchesTable" class="display">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Batch ID</th>
                        <th>Record Count</th>
                        <th>Received At</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="Heartbeats" class="tabcontent">
        <h2>Heartbeat Logs</h2>
        <div class="table-container">
            <table id="heartbeatsTable" class="display">
                <thead>
                    <tr>
                        <th>Sensor ID</th>
                        <th>Timestamp</th>
                        <th>Received At</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
    // Store DataTable instances
    const initializedTables = {};
    let currentActiveTab = 'PDNS';

    function openTab(evt, tabName) {
        // Declare all variables
        let i, tabcontent, tablinks;

        // Get all elements with class="tabcontent" and hide them
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        // Get all elements with class="tablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
        currentActiveTab = tabName;
        
        // Initialize DataTable if it hasn't been already
        const tableId = document.getElementById(tabName).querySelector('table').id;
        if (!initializedTables[tableId]) {
            initializeTable(tableId);
        } else {
            // Adjust columns for proper width if table was already initialized
            initializedTables[tableId].columns.adjust().draw();
        }
    }

    function initializeTable(tableId) {
        let config = {};
        
        if (tableId === 'pdnsTable') {
            config = {
                ajax: {
                    url: '/api/pdns-data',
                    dataSrc: function(json) {
                        if (json.error) {
                            console.error('PDNS API Error:', json.error);
                            alert('Error loading PDNS data: ' + json.error);
                            return [];
                        }
                        console.log('PDNS data loaded:', json.data.length, 'records');
                        return json.data;
                    },
                    error: function(xhr, error, code) {
                        console.error('PDNS AJAX Error:', error, code);
                        alert('Failed to load PDNS data. Check console for details.');
                    }
                },
                columns: [
                    { data: 'id' },
                    { data: 'timestamp' },
                    { data: 'domain' },
                    { data: 'resolved_ip' },
                    { 
                        data: 'status',
                        render: function(data, type, row) {
                            if (data) {
                                return '<span class="status-badge status-success">' + data + '</span>';
                            }
                            return '<span class="status-badge status-secondary">Unknown</span>';
                        }
                    },
                    { data: 'received_at' },
                    { data: 'processed_at' }
                ],
                order: [[5, 'desc']]
            };
        } else if (tableId === 'batchesTable') {
            config = {
                ajax: {
                    url: '/api/upload-batches',
                    dataSrc: function(json) {
                        if (json.error) {
                            console.error('Batches API Error:', json.error);
                            alert('Error loading batch data: ' + json.error);
                            return [];
                        }
                        console.log('Batches data loaded:', json.data.length, 'records');
                        return json.data;
                    },
                    error: function(xhr, error, code) {
                        console.error('Batches AJAX Error:', error, code);
                        alert('Failed to load batch data. Check console for details.');
                    }
                },
                columns: [
                    { data: 'id' },
                    { data: 'batch_id' },
                    { data: 'record_count' },
                    { data: 'received_at' },
                    { 
                        data: 'status',
                        render: function(data, type, row) {
                            const statusClass = data === 'processed' ? 'status-success' : 'status-warning';
                            return '<span class="status-badge ' + statusClass + '">' + data + '</span>';
                        }
                    }
                ],
                order: [[3, 'desc']]
            };
        } else if (tableId === 'heartbeatsTable') {
            config = {
                ajax: {
                    url: '/api/heartbeats',
                    dataSrc: function(json) {
                        if (json.error) {
                            console.error('Heartbeats API Error:', json.error);
                            alert('Error loading heartbeat data: ' + json.error);
                            return [];
                        }
                        console.log('Heartbeats data loaded:', json.data.length, 'records');
                        return json.data;
                    },
                    error: function(xhr, error, code) {
                        console.error('Heartbeats AJAX Error:', error, code);
                        alert('Failed to load heartbeat data. Check console for details.');
                    }
                },
                columns: [
                    { data: 'sensor_id' },
                    { data: 'timestamp' },
                    { data: 'received_at' }
                ],
                order: [[2, 'desc']]
            };
        }

        // Common DataTable settings
        config.pageLength = 25;
        config.responsive = true;
        config.processing = true;
        config.scrollX = true; // Enable horizontal scrolling for consistency
        config.autoWidth = false; // Disable auto width to use fixed column widths
        config.language = {
            emptyTable: "No data available"
        };

        initializedTables[tableId] = $('#' + tableId).DataTable(config);
    }

    function refreshActiveTable() {
        const activeTableId = document.getElementById(currentActiveTab).querySelector('table').id;
        if (initializedTables[activeTableId]) {
            initializedTables[activeTableId].ajax.reload(null, false);
        }
    }

    // Get the element with id="defaultOpen" and click on it to open the first tab
    document.getElementById("defaultOpen").click();

    // Auto-refresh every 30 seconds
    setInterval(function() {
        refreshActiveTable();
    }, 30000);
</script>

</body>
</html>